static_resources:
  listeners:
  # =========================================================
  # 1) Main mTLS listener (Clients -> Envoy) on 8080
  # =========================================================
  - name: http_proxy_listener
    address:
      socket_address:
        address: 0.0.0.0
        port_value: 8080

    filter_chains:
    - transport_socket:
        name: envoy.transport_sockets.tls
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.DownstreamTlsContext

          common_tls_context:
            tls_params:
              tls_minimum_protocol_version: TLSv1_2
              tls_maximum_protocol_version: TLSv1_3
              cipher_suites:
                - ECDHE-ECDSA-AES256-GCM-SHA384
                - ECDHE-RSA-AES256-GCM-SHA384
                - ECDHE-ECDSA-AES128-GCM-SHA256
                - ECDHE-RSA-AES128-GCM-SHA256

            tls_certificates:
            - certificate_chain:
                filename: "/etc/envoy/certs/server.crt"
              private_key:
                filename: "/etc/envoy/certs/server.key"

            validation_context:
              trusted_ca:
                filename: "/etc/envoy/certs/ca.crt"

          require_client_certificate: true

      filters:
      - name: envoy.filters.network.http_connection_manager
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager

          stat_prefix: http_proxy
          codec_type: AUTO

          stream_idle_timeout: 300s
          request_timeout: 30s

          access_log:
          - name: envoy.access_loggers.file
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.access_loggers.file.v3.FileAccessLog
              path: "/var/log/envoy/access.log"

          route_config:
            name: local_route
            virtual_hosts:
            - name: api_service
              domains: ["*"]
              routes:
              - match:
                  prefix: "/"
                route:
                  cluster: api_cluster
                  host_rewrite_literal: "${upstream_host}"

          http_filters:
          - name: envoy.filters.http.router
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router

  # =========================================================
  # 2) Plain HTTP health listener for NLB + debugging
  #    http://<ip>:8001/health -> "OK"
  # =========================================================
  - name: healthcheck_listener
    address:
      socket_address:
        address: 0.0.0.0
        port_value: 8001

    filter_chains:
    - filters:
      - name: envoy.filters.network.http_connection_manager
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager

          stat_prefix: healthcheck
          codec_type: AUTO

          route_config:
            name: healthcheck_route
            virtual_hosts:
            - name: health
              domains: ["*"]
              routes:
              - match:
                  prefix: "/health"
                direct_response:
                  status: 200
                  body:
                    inline_string: "OK"

          http_filters:
          - name: envoy.filters.http.router
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router


  clusters:
  # =========================================================
  # Upstream cluster (Envoy -> Upstream ALB/API)
  # =========================================================
  - name: api_cluster
    type: STRICT_DNS
    connect_timeout: 5s
    lb_policy: ROUND_ROBIN
    dns_lookup_family: V4_ONLY

    load_assignment:
      cluster_name: api_cluster
      endpoints:
      - lb_endpoints:
        - endpoint:
            address:
              socket_address:
                address: ${upstream_host}
                port_value: 443

    transport_socket:
      name: envoy.transport_sockets.tls
      typed_config:
        "@type": type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.UpstreamTlsContext

        sni: "${upstream_host}"

        common_tls_context:
          tls_params:
            tls_minimum_protocol_version: TLSv1_2
            tls_maximum_protocol_version: TLSv1_3
            cipher_suites:
              - ECDHE-ECDSA-AES256-GCM-SHA384
              - ECDHE-RSA-AES256-GCM-SHA384
              - ECDHE-ECDSA-AES128-GCM-SHA256
              - ECDHE-RSA-AES128-GCM-SHA256

          validation_context:
            trusted_ca:
              filename: "/etc/ssl/certs/ca-certificates.crt"
            match_typed_subject_alt_names:
            - san_type: DNS
              matcher:
                exact: "${upstream_host}"


admin:
  address:
    socket_address:
      address: 127.0.0.1
      port_value: 9901
